name: Build CLB Manifest

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_manifest:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate Manifest
      run: |
        echo "Generating CLB manifest.json"

        mkdir -p firmware   # ensure firmware folder exists

        MANIFEST="firmware/manifest.json"

        echo "{" > $MANIFEST
        echo '  "files": {' >> $MANIFEST

        REPO="CrazyRobMiles/MicroPython-Connected-Little-Box"
        FIRST=1

        # Scan only files inside firmware directory
        for f in $(find firmware -type f -name "*.py"); do
          FILEPATH="${f}"

          # Extract version string
          VERSION=$(grep -Eo '__version__ *= *"[^"]+"' "$f" | head -n 1 | cut -d'"' -f2)
          if [ -z "$VERSION" ]; then
            VERSION=$(grep -Eo 'version *= *"[^"]+"' "$f" | head -n 1 | cut -d'"' -f2)
          fi
          if [ -z "$VERSION" ]; then
            VERSION="0.0.0"
          fi

          # Compute version_id (major*10000 + minor*100 + patch)
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          VERSION_ID=$(( MAJOR*10000 + MINOR*100 + PATCH ))

          # Compute SHA for integrity checking
          SHA=$(sha256sum "$f" | cut -d' ' -f1)

          # Generate URL pointing to GitHub raw
          URL="https://raw.githubusercontent.com/$REPO/main/$FILEPATH"

          # JSON formatting
          if [ $FIRST -eq 1 ]; then
            FIRST=0
          else
            echo ',' >> $MANIFEST
          fi

          echo "    \"$FILEPATH\": {" >> $MANIFEST
          echo "      \"version\": \"$VERSION\"," >> $MANIFEST
          echo "      \"version_id\": $VERSION_ID," >> $MANIFEST
          echo "      \"sha\": \"$SHA\"," >> $MANIFEST
          echo "      \"url\": \"$URL\"" >> $MANIFEST
          echo -n "    }" >> $MANIFEST
        done

        echo "" >> $MANIFEST
        echo '  }' >> $MANIFEST
        echo '}' >> $MANIFEST

        echo "Manifest written to $MANIFEST"

    - name: Commit and push manifest.json
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Auto-generated manifest.json"
        file_pattern: "manifest.json"
